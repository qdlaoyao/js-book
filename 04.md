# Stringç±»å‹ä¸UTF-16

è¯·çœ‹ä¸€é“é¢è¯•é¢˜ï¼š

```javascript
'ğŸ˜‚'.length // ?
```
å…¶ç»“æœä¸æ˜¯ 1ï¼Œè€Œæ˜¯ 2ã€‚ğŸ˜‚ğŸ˜‚ğŸ˜‚

ä¸ºä»€ä¹ˆä¼šæ˜¯è¿™æ ·ï¼Ÿ

æœ¬æ–‡ä¸»è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

é¦–å…ˆæˆ‘ä»¬ä» [Unicode](https://zh.wikipedia.org/wiki/Unicode) è¯´èµ·ã€‚ä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜ï¼Œæˆ‘ä»¬éƒ½åº”è¯¥æˆ–å¤šæˆ–å°‘äº†è§£å…¶ç›¸å…³çŸ¥è¯†ã€‚

ä¸–ç•Œä¸Šæœ‰é‚£ä¹ˆå¤šè¯­è¨€ç³»ç»Ÿï¼Œæ¯é—¨è¯­è¨€åˆæœ‰é‚£å¤šæ–‡å­—å­—ç¬¦ã€‚

ä¸ºäº†åœ¨è®¡ç®—æœºä¸Šè¡¨ç¤ºè¿™äº›å­—ç¬¦ï¼Œä¸€ä¸ªå¤©ç„¶çš„æƒ³æ³•å°±æ˜¯ç»™æ¯ä¸ªå­—ç¬¦ä¸€ä¸ªç¼–å·ã€‚æŠŠæ¯ä¸€ä¸ªå­—ç¬¦æ˜ å°„æˆä¸€ä¸ªæ•´æ•°ï¼Œè¿™äº›æ•°å­—çš„å­¦åå«ç ä½ï¼ˆcode pointï¼‰ã€‚æ¯”å¦‚ï¼š

```javascript
'a'.charCodeAt(0) // 97
'å§š'.charCodeAt(0) // 23002
```

ç©¶ç«Ÿå¾—å¤šå°‘ä¸ªç ä½æ‰å¤Ÿå‘¢ï¼Ÿåˆšå¼€å§‹ `Unicode` è®¾è®¡äººå‘˜è§‰å¾— 2^16 (65536)å°±è¯¥è¶³å¤Ÿäº†ï¼Œäºæ˜¯äº§ç”Ÿäº† `UCS-2`ã€‚ï¼ˆæ³¨ï¼šäº‹å®ä¸Š `Unicode` å’Œ `UCS` åœ¨æœ€å¼€å§‹æ—¶ä¸æ˜¯ä¸€å®¶ã€‚ï¼‰

å– 16 æ¬¡æ–¹ï¼Œå³è¯´æ˜ 2 ä¸ªå­—èŠ‚æ•°æ®å°±èƒ½è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦äº†ã€‚è¿™ç§ç¼–ç æ–¹å¼å¤šç®€å•ï¼Œä¸ç®¡æ˜¯ä»æ€§èƒ½è¿˜æ˜¯ä»å®ç°ä¸Šæ¥è¯´ï¼Œéƒ½çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚å› æ­¤ï¼Œå¾ˆå¤šè¯­è¨€éƒ½é‡‡ç”¨äº†16 ä½ç¼–ç çš„å­—ç¬¦ä¸²ï¼ŒåŒ…æ‹¬å’±ä»¬çš„ `JavaScript`ã€‚

è™½ç„¶ 6 ä¸‡å¤šä¸ªå­—ç¬¦è¶³ä»¥åŒ…æ‹¬ä¸–ç•Œä¸Šç»å¤§å¤šæ•°å¸¸ç”¨å­—ç¬¦ï¼Œä½†äº‹å®ä¸Šè¿˜æ˜¯ä¸å¤Ÿçš„ï¼Œ`Unicode` ä¸æ–­æ‰©å±•ã€‚æˆªæ­¢ 2019 å¹´ 3 æœˆï¼Œå·²æ”¶å…¥ 150 ä¸ªä¹¦å†™ç³»ç»Ÿï¼Œå…±è®¡å­—ç¬¦ 137928 çš„ã€‚

ç»Ÿä¸€ç”¨ä¸¤ä¸ªå­—èŠ‚æ¥å­˜å‚¨ä¸€ä¸ªå­—ç¬¦ï¼Œè¿™ç§æ–¹å¼ä¸å†ä¸€ç›´æœ‰æ•ˆã€‚å› æ­¤å‡ºç°äº†ä¸åŒçš„ç¼–ç æ ‡å‡†ï¼Œæ¯”å¦‚ `UTF-8`ã€`UTF-16` å’Œ `UTF-32`ã€‚

è¿™é‡Œä¸»è¦è¯´è¯´ä¸ JS ç›¸å…³çš„ `UTF-16`ã€‚

`UTF-16` æ˜¯ä¸€ç§å˜é•¿è¡¨ç¤ºï¼Œå®ƒå¯¹æ¥è‡ªå¸¸ç”¨å­—ç¬¦ `UCS-2` çš„ç ä½ï¼Œä»ç„¶ç”¨ 2 ä¸ªå­—èŠ‚è¡¨ç¤ºã€‚è€Œå¯¹æ¥æ–°å¢éå¸¸ç”¨çš„ç ä½å´ç”¨ 4 ä¸ªå­—èŠ‚è¡¨ç¤ºã€‚äºŒè€…èƒ½äº’ç›¸åŒºåˆ†å¼€æ¥ï¼Œè¿™æ˜¯ `UTF-16` çš„ç²¾å¦™ä¹‹å¤„æ‰€åœ¨ã€‚

å¦å¤–éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæœ€å¼€å§‹çš„ 2^16 é‚£äº›æ•°æ®ä¸­å¹¶ééƒ½æ˜ å°„æ»¡äº†ã€‚ä» `U+D800`ï¼ˆ55296ï¼‰ åˆ° `U+DFFF`ï¼ˆ57343ï¼‰å…± 2048 ä¸ªç ä½ï¼Œæ˜¯æ°¸ä¹…ä¿ç•™çš„ï¼Œä¸æ˜ å°„åˆ°ä»»ä½• `Unicode` å­—ç¬¦ã€‚å®ƒçš„å­˜åœ¨ä¸º `UTF-16` æä¾›äº†æ–¹ä¾¿ã€‚

ä¸¾ä¾‹æ¥è¯´ï¼Œå­—ç¬¦ğŸ˜‚çš„ç ä½æ˜¯ `U+1F602`(128514)ï¼Œå¤§äº 65535ï¼Œå› æ­¤æ˜¯åæ·»åŠ çš„å­—ç¬¦ã€‚

é¦–å…ˆç”¨å®ƒå…ˆå‡å» 65536ï¼Œå¾—åˆ° 62978ï¼Œå¯¹åº”çš„äºŒè¿›åˆ¶æ˜¯ `1111011000000010`ã€‚

ç„¶åå·¦è¡¥å…… 0 è‡³ 20 ä½ï¼š`00001111011000000010`ã€‚

å†ä»ä¸­é—´åˆ‡æ–­æˆä¸Šä¸‹ä¸¤å€¼ï¼š`0000111101`ï¼ˆ61ï¼‰ å’Œ `1000000010`ï¼ˆ514ï¼‰ã€‚

æ·»åŠ  `0xD800`ï¼ˆ55296ï¼‰åˆ°ä¸Šå€¼ï¼Œä»¥å½¢æˆé«˜ä½ï¼š55296 + 61 = 55357ï¼ˆ`0xD83D`ï¼‰ã€‚

æ·»åŠ  `0xDC00`ï¼ˆ56320ï¼‰åˆ°ä¸‹å€¼ï¼Œä»¥å½¢æˆä½ä½ï¼š56320+ 514 = 56834ï¼ˆ`0xDE02`ï¼‰ã€‚

`0xD83D` ä¸ `0xDE02 `æ„æˆä¸€ä¸ªä»£ç†å¯¹ï¼Œæ¥è¡¨ç¤ºç ä½ `U+1F602`ã€‚

å¯ä»¥éªŒè¯å¦‚ä¸‹ï¼š

```javascript
'ğŸ˜‚'.charCodeAt(0) // 55357
'ğŸ˜‚'.charCodeAt(1) // 56834
'\u{1F602}' // ğŸ˜‚
'\uD83D\uDE02' // ğŸ˜‚
'\u{1F602}'[0] === '\uD83D' // true
```

æ­¤æ—¶ï¼Œæƒ³å¿…ä½ ä¹Ÿæ˜ç™½äº†æ–‡ç« å¼€å¤´çš„é—®é¢˜äº†ï¼š`'ğŸ˜‚'.length` ä¹‹æ‰€ä»¥ä¸º 2ï¼Œæ˜¯å› ä¸º `JS` è‡³ä»Šä»ç„¶ä½¿ç”¨ `UCS-2` é‚£ç§ 16 è¿›åˆ¶è¯»å–æ–¹å¼ã€‚

æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ JS è§„èŒƒ[ã€ŠEcma-262 Edition 5.1ã€‹](https://www.ecma-international.org/ecma-262/5.1/index.html#sec-8.4) å¯¹æ­¤çš„æè¿°ï¼š

> The String type is the set of all finite ordered sequences of zero or more 16-bit unsigned integer values (â€œelementsâ€). The String type is generally used to represent textual data in a running ECMAScript program, in which case each element in the String is treated as a code unit value (see Clause 6). Each element is regarded as occupying a position within the sequence. These positions are indexed with nonnegative integers. The first element (if any) is at position 0, the next element (if any) at position 1, and so on. The length of a String is the number of elements (i.e., 16-bit values) within it. The empty String has length zero and therefore contains no elements.
<br>
When a String contains actual textual data, each element is considered to be a single UTF-16 code unit. Whether or not this is the actual storage format of a String, the characters within a String are numbered by their initial code unit element position as though they were represented using UTF-16. All operations on Strings (except as otherwise stated) treat them as sequences of undifferentiated 16-bit unsigned integers; they do not ensure the resulting String is in normalised form, nor do they ensure language-sensitive results.

ç¿»è¯‘å¦‚ä¸‹ï¼š 

> å­—ç¬¦ä¸²ç±»å‹æ˜¯ç”± 0 ä½æˆ– 16 ä½ä»¥ä¸Šæ— ç¬¦å·æ•´æ•°å€¼(å…ƒç´ )ç»„æˆçš„æ‰€æœ‰æœ‰é™æœ‰åºåºåˆ—çš„é›†åˆã€‚å­—ç¬¦ä¸²ç±»å‹é€šå¸¸ç”¨äºè¡¨ç¤ºè¿è¡Œä¸­çš„ECMAScript ç¨‹åºä¸­çš„æ–‡æœ¬æ•°æ®ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½è¢«è§†ä¸ºç å…ƒå€¼(å‚è§ç¬¬6æ¡)ã€‚è¿™äº›ä½ç½®ç”¨éè´Ÿæ•´æ•°ä½œç´¢å¼•ã€‚ç¬¬ä¸€ä¸ªå…ƒç´ (å¦‚æœæœ‰)ä½äºä½ç½® 0ï¼Œä¸‹ä¸€ä¸ªå…ƒç´ (å¦‚æœæœ‰)ä½äºä½ç½® 1ï¼Œä»¥æ­¤ç±»æ¨ã€‚å­—ç¬¦ä¸²çš„é•¿åº¦æ˜¯å…ƒç´ çš„æ•°é‡(å³ï¼Œ16ä½å€¼)ã€‚ç©ºå­—ç¬¦ä¸²çš„é•¿åº¦ä¸ºé›¶ï¼Œå› æ­¤ä¸åŒ…å«ä»»ä½•å…ƒç´ ã€‚
<br>
å½“å­—ç¬¦ä¸²åŒ…å«å®é™…çš„æ–‡æœ¬æ•°æ®æ—¶ï¼Œæ¯ä¸ªå…ƒç´ éƒ½è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå•ç‹¬çš„ UTF-16 ç å…ƒã€‚æ— è®ºè¿™æ˜¯å¦æ˜¯å­—ç¬¦ä¸²çš„å®é™…å­˜å‚¨æ ¼å¼ï¼Œå­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦éƒ½æ˜¯é€šè¿‡å…¶åˆå§‹ç å…ƒå…ƒç´ ä½ç½®è¿›è¡Œç¼–å·çš„ï¼Œå°±åƒä½¿ç”¨ UTF-16 è¡¨ç¤ºä¸€æ ·ã€‚æ‰€æœ‰å­—ç¬¦ä¸²ä¸Šçš„æ“ä½œ(é™¤éå¦æœ‰è¯´æ˜)éƒ½å°†å®ƒä»¬è§†ä¸ºæ— å·®å¼‚ 16 ä½æ— ç¬¦å·æ•´æ•°çš„åºåˆ—ï¼Œå®ƒä»¬ä¸èƒ½ç¡®ä¿å¾—åˆ°çš„å­—ç¬¦ä¸²æ˜¯æ ‡å‡†æ ¼å¼çš„ï¼Œä¹Ÿä¸èƒ½ç¡®ä¿å¾—åˆ°å¯¹è¯­è¨€æ•æ„Ÿçš„ç»“æœã€‚

å…¶ä¸­æåˆ°äº†ç å…ƒï¼ˆ`code unit`ï¼‰ï¼Œæ˜¯æŒ‡æœ€å­˜å‚¨çš„æœ€å°å•ä½ï¼Œè¿™é‡Œå³ 2 ä¸ªå­—èŠ‚ã€‚

å‰æ–‡è®¨è®ºè¿‡ï¼Œå¤§äº 65535 çš„ç ä½ä¼šç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹ï¼ˆæ¯”å¦‚ğŸ˜‚çš„ç ä½æ˜¯ `U+1F602`ï¼Œä»£ç†å¯¹æ˜¯ 
`U+D83D` å’Œ `U+DE02`ï¼‰ï¼Œå³ç”¨äº† 2 ä¸ªç å…ƒã€‚ä¸Šè¿° JS è§„èŒƒä¸­æ˜ç¡®å¾—æŒ‡å‡ºï¼šâ€œæ¯ä¸ªå…ƒç´ éƒ½è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå•ç‹¬çš„ `UTF-16` ç å…ƒâ€ã€‚å› æ­¤ğŸ˜‚ç¬¦å·ä¸º 2ã€‚


æœ¬æ–‡å®Œã€‚

[ã€ŠJavaScript è¿·ä½ ä¹¦ã€‹ä¼ é€é—¨ï¼Œå…¨é¢å¤¯å®åŸºç¡€](https://github.com/qdlaoyao/js-book)

[æ˜é‡‘æ”¶è—](https://juejin.im/collection/5ccfe1216fb9a0025a21dde3)












